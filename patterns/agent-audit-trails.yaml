id: agent-audit-trails
category: patterns
priority: 20
updated: 2026-02-03

title: Agent Cryptographic Audit Trails
description: |
  Patterns for creating tamper-evident audit trails of agent decisions and
  actions using hash chains, HMAC signing, and structured event recording.

rules:
  - action: ALWAYS
    rule: "Record every agent action as a structured audit event with: timestamp, agent ID, action type, input summary, output summary, authority level, approval chain"
  - action: ALWAYS
    rule: "Chain audit entries using cryptographic hashes - each entry includes the hash of the previous entry creating a tamper-evident sequence"
  - action: ALWAYS
    rule: "Sign audit entries with HMAC-SHA256 using a key not accessible to the agents being audited"
  - action: ALWAYS
    rule: "Include a genesis hash as the first entry in every audit chain to establish a verifiable starting point"
  - action: ALWAYS
    rule: "Implement chain verification that detects gaps, modifications, or out-of-order entries"
  - action: NEVER
    rule: "Allow agents to modify, delete, or reorder audit trail entries"
  - action: NEVER
    rule: "Store the audit signing key in the same context or memory space accessible to audited agents"
  - action: NEVER
    rule: "Skip audit logging for any action, even failed or rejected ones - denied actions are evidence"
  - action: PREFER
    rule: "Append-only storage for audit trails (write-once, read-many)"
  - action: PREFER
    rule: "Periodic chain integrity verification as a background process"

anti_patterns:
  - "Unstructured text logs instead of structured events - difficult to query, analyze, or verify programmatically"
  - "No hash chaining allowing silent modification - individual entries can be altered without detection"
  - "Agents with access to audit signing keys - compromised agents can forge legitimate-looking audit entries"
  - "Gaps in audit coverage for 'unimportant' actions - incomplete trails cannot prove what did or did not happen"
  - "Audit logs stored alongside agent-writable data - agents can tamper with their own audit history"

examples:
  audit_event_structure: |
    {
      "entryId": "evt-2026-0203-00042",
      "previousHash": "sha256:a1b2c3d4e5f6...",
      "timestamp": "2026-02-03T14:30:00.000Z",
      "agentId": "agent-worker-07",
      "actionType": "file_write",
      "inputSummary": "Write 42 lines to /src/config.ts",
      "outputSummary": "Success - file written, 42 lines",
      "authorityLevel": "standard",
      "approvalChain": ["agent-coordinator-01"],
      "hmacSignature": "hmac-sha256:f7e8d9c0b1a2..."
    }

  hash_chain_verification: |
    function verifyAuditChain(entries) {
      if (entries[0].previousHash !== GENESIS_HASH) {
        return { valid: false, error: "Invalid genesis entry" };
      }
      for (let i = 1; i < entries.length; i++) {
        const expectedHash = sha256(JSON.stringify(entries[i - 1]));
        if (entries[i].previousHash !== expectedHash) {
          return {
            valid: false,
            error: `Chain broken at entry ${i}`,
            entryId: entries[i].entryId
          };
        }
        if (!verifyHmac(entries[i], AUDIT_SIGNING_KEY)) {
          return {
            valid: false,
            error: `Invalid signature at entry ${i}`,
            entryId: entries[i].entryId
          };
        }
      }
      return { valid: true, entriesVerified: entries.length };
    }

context: |
  Derived from agent governance patterns in multi-agent orchestration systems.
  When autonomous agents take actions with real-world consequences, a reliable
  audit trail is essential for accountability, debugging, and compliance. Simple
  text logs are insufficient because they can be silently modified. Cryptographic
  hash chaining creates a tamper-evident sequence where any modification to a
  past entry invalidates all subsequent hashes. HMAC signing ensures that only
  the audit system (not the agents) can create valid entries. Together, these
  patterns provide a verifiable record of every agent action.

related:
  - agent-enforcement-gates
  - agent-authority-hierarchy

tags:
  - audit
  - cryptographic
  - hash-chain
  - tamper-evident
  - compliance
  - accountability
